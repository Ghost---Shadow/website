"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[475],{7264:function(e,t,n){n.r(t),n.d(t,{default:function(){return c}});var s=n(2556),i=n.p+"static/media/istio-vs-vanila.c33322030e313da49ae2.png",o=n.p+"static/media/why-virtual-services.036662d88f5304778262.png",a=n.p+"static/media/packet-flow-out-to-in.0d7227cd8ab1f406cfa1.png",r=n.p+"static/media/packet-flow-inter-pod.300245d7a24d2b3561f6.png";function l(e){const t=Object.assign({h1:"h1",p:"p",h2:"h2",a:"a",h3:"h3",blockquote:"blockquote",pre:"pre",code:"code",ol:"ol",li:"li",ul:"ul"},e.components);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.h1,{children:"How to migrate from vanilla Kubernetes to Istio service mesh?"}),"\n",(0,s.jsx)("date",{children:"14 Oct 2019"}),"\n",(0,s.jsx)(t.p,{children:"The goal of this guide is to give the reader the most concise and non-intimidating introduction to istio while simultaneously providing further reading material if it piques his interest."}),"\n",(0,s.jsx)(t.p,{children:"Before we start with the installation, let us compare it with vanilla Kubernetes."}),"\n",(0,s.jsx)(t.h2,{children:"Template flow vanilla vs istio"}),"\n",(0,s.jsx)(t.p,{children:"Instead of ingress, we have gateways which connect to virtual services. Everything else downstream remains the same."}),"\n",(0,s.jsx)("img",{width:"100%",src:i,alt:"istio service mesh vs vanilla kubernetes"}),"\n",(0,s.jsx)(t.h2,{children:"Why virtual services?"}),"\n",(0,s.jsxs)(t.p,{children:["Virtual services provide many features like\n",(0,s.jsx)(t.a,{href:"https://istio.io/latest/docs/tasks/traffic-management/traffic-shifting/",children:"infra level AB testing"}),",\n",(0,s.jsx)(t.a,{href:"https://istio.io/latest/docs/tasks/traffic-management/fault-injection/",children:"fault injection"}),",\n",(0,s.jsx)(t.a,{href:"https://istio.io/latest/docs/tasks/traffic-management/circuit-breaking/",children:"circuit breaking"})," and a\n",(0,s.jsx)(t.a,{href:"https://istio.io/latest/docs/tasks/",children:"lot more"}),"."]}),"\n",(0,s.jsx)("img",{width:"100%",src:o,alt:"why use virtual services"}),"\n",(0,s.jsx)(t.h2,{children:"Packet flow"}),"\n",(0,s.jsx)(t.h3,{children:"Out to in"}),"\n",(0,s.jsxs)(t.p,{children:["Whenever a new deployment is created in an\n",(0,s.jsx)(t.a,{href:"https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/#automatic-sidecar-injection",children:"istio-injected namespace"}),"\nan ",(0,s.jsx)(t.a,{href:"https://www.envoyproxy.io/docs/envoy/latest/intro/what_is_envoy",children:"envoy container"})," is inserted into the pod.\nIt is widely referred to as sidecar. It automatically intercepts all incoming and outgoing requests. The application does not need to worry about this abstraction."]}),"\n",(0,s.jsxs)(t.blockquote,{children:["\n",(0,s.jsx)(t.p,{children:"TIP: Reading the logs of the envoy is useful for debugging"}),"\n"]}),"\n",(0,s.jsx)("img",{width:"100%",src:a,alt:"Packet flow out to in"}),"\n",(0,s.jsx)(t.h3,{children:"Intra cluster"}),"\n",(0,s.jsxs)(t.p,{children:["One of the benefits of having the envoy is that we can have\n",(0,s.jsx)(t.a,{href:"https://istio.io/docs/tasks/security/mutual-tls/",children:"mutual TLS"})," secured connections inside the cluster.\nIt helps in the realization of ",(0,s.jsx)(t.a,{href:"https://blog.aquasec.com/istio-kubernetes-security-zero-trust-networking",children:"zero-trust networks"}),"."]}),"\n",(0,s.jsxs)(t.p,{children:["One of the functions of the ",(0,s.jsx)(t.a,{href:"https://www.youtube.com/watch?v=fqour4ZBzHg",children:"pilot"})," is being a\n",(0,s.jsx)(t.a,{href:"https://www.youtube.com/watch?v=NrzrpyMLWes",children:"service discovery service"}),"."]}),"\n",(0,s.jsx)("img",{width:"100%",src:r,alt:"Packet flow inter pod"}),"\n",(0,s.jsx)(t.h2,{children:"Installation"}),"\n",(0,s.jsxs)(t.blockquote,{children:["\n",(0,s.jsx)(t.p,{children:"This guide was written during istio 1.3.x, if things have changed too much in the future, consider consulting the official documentation."}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"We will be installing istio for Kubernetes cluster using helm charts."}),"\n",(0,s.jsxs)(t.p,{children:["You can find the detailed process in ",(0,s.jsx)(t.a,{href:"https://istio.io/latest/docs/setup/install/helm/",children:"istio official website"}),", but here is a quick version."]}),"\n",(0,s.jsxs)(t.p,{children:["First, make sure helm and helm tiler is installed. For more details on helm, refer to the ",(0,s.jsx)(t.a,{href:"https://helm.sh/docs/using_helm/",children:"official guide"}),"."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-sh",children:"brew install helm\nhelm init\n"})}),"\n",(0,s.jsxs)(t.p,{children:["In case you are unable to install helm tiler for some reason, you can just ",(0,s.jsx)(t.a,{href:"https://stackoverflow.com/questions/50584091/helm-export-yaml-files-locally-just-use-templating-engine-do-not-send-to-kuber",children:"export the helm charts as k8s templates"}),"."]}),"\n",(0,s.jsx)(t.p,{children:"Next, we install istio"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-sh",children:"# First we create the namespace for istio\nkubectl create namespace istio-system\n\n# Add the helm repo\nhelm repo add istio.io https://storage.googleapis.com/istio-release/releases/1.3.1/charts/\n\n# Istio bootstrapper \n# (make sure this process finishes, the pods should be in \"finished\" state)\nhelm install istio.io/istio-init --name istio-init --namespace istio-system\n\n# Should be 23 (at time of writing this guide)\n# kubectl get crds | grep 'istio.io' | wc -l\n\n# Actual istio\n# You can read about SDS over here (https://preliminary.istio.io/docs/tasks/traffic-management/ingress/secure-ingress-sds/)\nhelm install istio.io/istio --name istio --set gateways.istio-ingressgateway.sds.enabled=true --set sds.enabled=true --namespace istio-system\n\n# Verify the installation\n# kubectl get svc -n istio-system\n# kubectl get deployment -n istio-system\n"})}),"\n",(0,s.jsx)(t.p,{children:"In order for deployments in your namespace to use istio, we need to enable istio injection."}),"\n",(0,s.jsxs)(t.blockquote,{children:["\n",(0,s.jsx)(t.p,{children:"IMPORTANT: You have to delete and recreate your existing deployments."}),"\n"]}),"\n",(0,s.jsxs)(t.blockquote,{children:["\n",(0,s.jsxs)(t.p,{children:["IMPORTANT: You don't have to inject ",(0,s.jsx)(t.code,{children:"istio-system"}),"."]}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-sh",children:"# The following command enables injection in the potato namespace\nkubectl label namespace potato istio-injection=enabled\n\n# To verify\nkubectl get namespace -L istio-injection\n"})}),"\n",(0,s.jsx)(t.p,{children:"Next, you need to create a gateway. Use this one as a sample."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-yml",children:"apiVersion: networking.istio.io/v1alpha3\nkind: Gateway\nmetadata:\n  name: my-gateway\n  namespace: istio-system\nspec:\n  selector:\n    istio: ingressgateway # use Istio default gateway implementation\n  servers:\n    - port:\n        number: 80\n        name: http\n        protocol: HTTP\n      hosts:\n          # - yourdomain.com\n          - '*' # Allow everything\n      # Uncomment next two lines if you dont want any insecure connections\n      # to your website\n      # tls:\n      #   httpsRedirect: true # sends 301 redirect for http requests\n    # Uncomment next block if you want HTTPS\n    # - port:\n    #     number: 443\n    #     name: https\n    #     protocol: HTTPS\n    #   hosts:\n    #     - yourdomain.com\n    #   tls:\n    #     mode: SIMPLE\n    #     credentialName: your.secret\n"})}),"\n",(0,s.jsx)(t.p,{children:"You would also need virtual services to bridge gateways to services. Use this one as a sample."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-yml",children:"apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: tomato-virtual-service\n  namespace: potato\nspec:\n  gateways:\n    - istio-system/my-gateway # namespace-where-gateway-is/gateway-name\n  hosts:\n    # - mydomain.com\n    - '*' # Allow everything\n  http:\n  - match:\n    - uri:\n        prefix: /tomato\n    rewrite:\n      uri: /\n    route:\n    - destination:\n        # Name of the service we want to connect to\n        host: tomato.potato.svc.cluster.local # service-name.namespace.svc.cluster.local\n        port:\n          number: 8080 # Port forwarded by the service\n      weight: 100\n"})}),"\n",(0,s.jsx)(t.p,{children:"Everything from service and below is the same as vanilla Kubernetes."}),"\n",(0,s.jsxs)(t.blockquote,{children:["\n",(0,s.jsxs)(t.p,{children:["TROUBLESHOOTING: The ",(0,s.jsx)(t.code,{children:"ingress-gateway"})," in ",(0,s.jsx)(t.code,{children:"istio-system"})," pod is the load balancer.\nIf you are unable to find the external IP of the cluster, try the external IP of the node running this pod.\nYou can read more ",(0,s.jsx)(t.a,{href:"https://istio.io/docs/tasks/traffic-management/ingress/ingress-control/#determining-the-ingress-ip-and-ports",children:"here"}),"."]}),"\n"]}),"\n",(0,s.jsx)(t.h2,{children:"Installing istioctl (optional)"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-sh",children:'cd ~/\ncurl -L https://git.io/getLatestIstio\nexport PATH="$PATH:~/istio-1.3.0-rc.3/bin" # Assuming the version is 1.3.0\n'})}),"\n",(0,s.jsx)(t.h2,{children:"Troubleshooting"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["Read the pod logs (Start with ingress-gateway, pilot, envoys). ",(0,s.jsx)(t.a,{href:"https://istio.io/docs/ops/troubleshooting/proxy-cmd/",children:"Further reading"}),"."]}),"\n",(0,s.jsx)(t.li,{children:"Kill all the pods in istio-system"}),"\n",(0,s.jsx)(t.li,{children:"Delete and create the gateway again"}),"\n",(0,s.jsxs)(t.li,{children:["Install ",(0,s.jsx)(t.a,{href:"https://www.kiali.io/documentation/getting-started/#_installation",children:"kiali"})," ",(0,s.jsx)(t.code,{children:"bash <(curl -L https://git.io/getLatestKialiOperator) --accessible-namespaces '**'"})]}),"\n",(0,s.jsxs)(t.li,{children:["Run ",(0,s.jsx)(t.a,{href:"https://stackoverflow.com/a/57920503/1217998",children:"this"})," to get a dump of all routes connected to the gateway. (requires istioctl)"]}),"\n",(0,s.jsxs)(t.li,{children:["Watch these two videos. ",(0,s.jsx)(t.a,{href:"https://www.youtube.com/watch?v=FbYBO7Pi2d8",children:"#1"})," ",(0,s.jsx)(t.a,{href:"https://www.youtube.com/watch?v=7cINRP0BFY8",children:"#2"})]}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["If all fails you can ",(0,s.jsx)(t.a,{href:"https://stackoverflow.com/questions/51594064/what-is-ther-purpose-of-helm-delete-purge",children:"helm delete-purge istio"}),", then ",(0,s.jsx)(t.code,{children:"kubectl delete namespace istio-system"})," and start over again."]}),"\n",(0,s.jsx)(t.p,{children:"Good luck."}),"\n",(0,s.jsx)(t.h2,{children:"Jargon"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Envoy - Proxy inside your pods which intercepts all network traffic"}),"\n",(0,s.jsx)(t.li,{children:"Sidecar - The injected envoy container in your pods"}),"\n",(0,s.jsx)(t.li,{children:"Mixer - Collects telemetry and enforces usage policies."}),"\n",(0,s.jsx)(t.li,{children:"Pilot - Service discovery service"}),"\n",(0,s.jsx)(t.li,{children:"Citadel - Key management service"}),"\n",(0,s.jsx)(t.li,{children:"Galley - Configuration validation"}),"\n"]})]})}var c=function(e={}){const{wrapper:t}=e.components||{};return t?(0,s.jsx)(t,Object.assign({},e,{children:(0,s.jsx)(l,e)})):l(e)}}}]);
//# sourceMappingURL=475.c6d71a9f.chunk.js.map